<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interface Énergie - Émissions CO₂</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    :root {
      --boad-red: #a71930;
      --boad-red-dark: #891625;
      --white: #fff;
      --boad-yellow: #FFCC00;
      --boad-yellow-dark: #e6b800;
    }

    body { margin: 0; font-family: Arial, sans-serif; background: #fafafa; }

    /* ==== BARRE DE MENU HORIZONTALE ==== */
    header {
  background-color: var(--boad-red);
  height: 80px;
  padding: 0 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
  overflow: hidden;
}

    .header-left {
  display: flex;
  align-items: center;
  height: 100%;
}

.header-left img {
  height: 120px;
  width: auto;
  display: block;
  object-fit: contain;
}

    .header-center { flex-grow: 1; min-width: 250px; text-align: center; }
    .header-center h1 {
      margin: 0;
      font-weight: 700;
      font-size: 1.75rem;
      color: #fff;
      user-select: none;
    }
    nav.header-nav {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    nav.header-nav a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      transition: background-color 0.3s ease, color 0.3s ease;
      white-space: nowrap;
      font-size: 1rem;
    }
    nav.header-nav a:hover,
    nav.header-nav a:focus {
      background-color: rgba(255, 255, 255, 0.3);
      outline: none;
      color: #ffebc2;
    }
    .quit-btn {
      background-color: var(--boad-red-dark);
      color: white;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .quit-btn:hover { background-color: #70121d; }

    /* ==== CONTENU ==== */
    .main-content {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 20px;
      background: white;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
      border-radius: 8px;
    }

    h2 { color: var(--boad-red); margin-bottom: 20px; }

    .add-buttons {
      margin: 10px 0 20px;
      display: flex;
      gap: 15px;
    }
    .add-buttons button {
      background-color: var(--boad-yellow);
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      color: #333;
      transition: background-color 0.3s ease;
      flex-grow: 1;
    }
    .add-buttons button:hover {
      background-color: var(--boad-yellow-dark);
      color: #111;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
    }
    th {
      background-color: var(--boad-red);
      color: white;
      user-select: none;
    }
    tr.section-title td {
      background-color: #f4f4f4;
      font-weight: 700;
      font-size: 16px;
      color: var(--boad-red-dark);
    }
    tr.subtotal-row td {
      background-color: #fff8dc;
      font-weight: 600;
      font-size: 15px;
      color: var(--boad-red-dark);
    }
    tr.total-row td {
      background-color: var(--boad-red);
      color: var(--white);
      font-weight: bolder;
      font-size: 16px;
    }

    select, input[type="number"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    select:focus, input[type="number"]:focus {
      border-color: var(--boad-red);
      outline: none;
      box-shadow: 0 0 5px var(--boad-red);
    }

    .action-btn {
      background: none;
      border: none;
      color: var(--boad-red);
      font-size: 18px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .action-btn:hover { color: var(--boad-red-dark); }

    #enginDescription {
      margin-top: 20px;
      background: #fff3cc;
      padding: 15px;
      border-left: 6px solid var(--boad-yellow);
      border-radius: 4px;
      color: #5c3a00;
      font-style: italic;
      min-height: 50px;
    }

    .fixed-nav-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
    .fixed-nav-buttons button {
      background-color: var(--boad-yellow);
      color: #333;
      border: none;
      border-radius: 6px;
      padding: 12px 24px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 160px;
    }
    .fixed-nav-buttons button:hover {
      background-color: var(--boad-yellow-dark);
      color: #111;
    }

       body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('{{ url_for("static", filename="logo-boad.webp") }}');
    background-repeat: repeat;
    background-size: 80px auto;
    opacity: 0.08; /* très léger fond */
    pointer-events: none;
    z-index: -1;
  }

  </style>
</head>
<body>
  <!-- HEADER horizontal -->
  <header>
    <div class="header-left">
    <img src="{{ url_for('static', filename='BOADCarbone.png') }}" alt="Logo BOAD" />
  </div>
    <div class="header-center">
      <h1>Énergie – Émissions CO₂</h1>
    </div>
    <nav class="header-nav">
      <a href="{{ url_for('index') }}">Accueil</a>
      <a href="{{ url_for('apropos') }}">À propos</a>
      <a href="{{ url_for('contact') }}">Contacts</a>
      <a href="{{ url_for('aide') }}">Aide</a>
    </nav>
  </header>

  <main class="main-content">
    <h2>Énergie</h2>

    <div class="add-buttons">
      <button type="button" onclick="addEnergyRow('scope_1')">➕ Ajouter Scope 1</button>
      <button type="button" onclick="addEnergyRow('scope_2')">➕ Ajouter Scope 2</button>
      <button type="button" onclick="addEnergyRow('scope_3')">➕ Ajouter Scope 3</button>
    </div>

    <table id="energyTable">
      <thead>
        <tr>
          <th>Catégorie</th>
          <th>Type d'énergie</th>
          <th>Quantité</th>
          <th>Émissions (kgCO₂e)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="energyBody"></tbody>
    </table>

    <div id="enginDescription"></div>

    <div class="fixed-nav-buttons">
      <button type="button" onclick="precedent()">← (2/3) Étape précédente</button>
      <button type="button" onclick="suivant()">Étape suivante (2/3) →</button>
    </div>
  </main>

<script>
  const enginsData = {{ engins_energie | tojson }};
  let energyRows = [];
  const scopes = Object.keys(enginsData);

  // -------- Helpers ----------
  function parseNum(v) {
    if (typeof v === 'number') return v;
    if (v === null || v === undefined) return 0;
    const n = parseFloat(String(v).replace(',', '.'));
    return isNaN(n) ? 0 : n;
  }
  function fmt2(x) {
    return (x || 0).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function afficherDescription(description) {
    document.getElementById('enginDescription').textContent = description || '';
  }

  function saveRowsToStorage() {
    sessionStorage.setItem('energyRows', JSON.stringify(energyRows));
  }

  function commitEmissionData(totalOverride = null) {
    const total = totalOverride !== null ? totalOverride
      : energyRows.reduce((acc, r) => acc + (parseNum(r.facteur) * parseNum(r.quantite)), 0);
    const emissionData = JSON.parse(localStorage.getItem("emissionData")) || {};
    emissionData.energie = total;
    const autresDetails = (emissionData.details || []).filter(item => item.categorie !== "Énergie");
    const nouveauxDetails = energyRows.map(row => ({
      nom: row.engin,
      categorie: "Énergie",
      scope: row.scope,
      facteur: parseNum(row.facteur),
      unite: row.unite || "U"
    }));
    emissionData.details = [...autresDetails, ...nouveauxDetails];
    localStorage.setItem("emissionData", JSON.stringify(emissionData));
  }

  // Met à jour uniquement les agrégats affichés (sous-total du scope + total général)
  function updateAggregates(scopeTouched = null) {
    // Sous-totaux par scope
    scopes.forEach(scope => {
      if (scopeTouched === null || scopeTouched === scope) {
        const sousTotal = energyRows
          .filter(r => r.scope === scope)
          .reduce((acc, r) => acc + (parseNum(r.facteur) * parseNum(r.quantite)), 0);
        const cell = document.getElementById(`subtotal-${scope}`);
        if (cell) cell.textContent = `${fmt2(sousTotal)} kgCO₂e`;
      }
    });
    // Total général
    const total = energyRows.reduce((acc, r) => acc + (parseNum(r.facteur) * parseNum(r.quantite)), 0);
    const totalCell = document.getElementById('total-energie');
    if (totalCell) totalCell.textContent = `${fmt2(total)} kgCO₂e`;
    commitEmissionData(total);
  }

  function renderTable() {
    const tbody = document.getElementById('energyBody');
    tbody.innerHTML = '';

    scopes.forEach(scope => {
      // Titre de section
      const trTitle = document.createElement('tr');
      trTitle.className = 'section-title';
      const tdTitle = document.createElement('td');
      tdTitle.colSpan = 5;
      tdTitle.textContent = scope.replace('_',' ').toUpperCase();
      trTitle.appendChild(tdTitle);
      tbody.appendChild(trTitle);

      // Lignes du scope
      const rowsFiltered = energyRows.filter(r => r.scope === scope);
      rowsFiltered.forEach(row => {
        const tr = document.createElement('tr');

        // Catégorie
        const tdCat = document.createElement('td');
        const selCat = document.createElement('select');
        selCat.innerHTML = `<option value="">-- Choisir --</option>`;
        Object.keys(enginsData[scope]).forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          if (row.categorie === cat) opt.selected = true;
          selCat.appendChild(opt);
        });
        selCat.onchange = e => {
          row.categorie = e.target.value;
          row.engin = '';
          row.facteur = 0;
          row.unite = 'U';
          afficherDescription('');
          saveRowsToStorage();
          renderTable(); // on re-render car la structure des options change
        };
        tdCat.appendChild(selCat);
        tr.appendChild(tdCat);

        // Énergie (engin)
        const tdEngin = document.createElement('td');
        const selEngin = document.createElement('select');
        selEngin.innerHTML = `<option value="">-- Choisir --</option>`;
        if (row.categorie && enginsData[scope][row.categorie]) {
          enginsData[scope][row.categorie].forEach(engin => {
            const opt = document.createElement('option');
            opt.value = engin.nom;
            opt.textContent = engin.nom;
            if (engin.nom === row.engin) opt.selected = true;
            selEngin.appendChild(opt);
          });
        }
        selEngin.onchange = e => {
          const selected = e.target.value;
          row.engin = selected;
          if (row.categorie) {
            const match = enginsData[scope][row.categorie].find(engin => engin.nom === selected);
            row.facteur = match ? parseNum(match.facteur) : 0;
            row.description = match ? match.description : '';
            row.unite = match ? (match.unite || 'U') : 'U';
            afficherDescription(row.description);
          }
          saveRowsToStorage();
          renderTable(); // re-render car le facteur / description changent
        };
        tdEngin.appendChild(selEngin);
        tr.appendChild(tdEngin);

        // Quantité
        const tdQte = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'number';
        input.inputMode = 'decimal';
        input.step = 'any';
        input.min = '0';
        input.value = row.quantite ?? 0;
        tdQte.appendChild(input);
        tr.appendChild(tdQte);

        // Émissions (cellule mise à jour à la volée)
        const tdEm = document.createElement('td');
        const total = parseNum(row.facteur) * parseNum(row.quantite);
        tdEm.textContent = fmt2(total);
        tr.appendChild(tdEm);

        // Action
        const tdAct = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'action-btn';
        btn.textContent = '🗑️';
        btn.onclick = () => {
          energyRows.splice(energyRows.indexOf(row), 1);
          afficherDescription('');
          saveRowsToStorage();
          renderTable();
        };
        tdAct.appendChild(btn);
        tr.appendChild(tdAct);

        // ---- Saisie fluide : pas de re-render pendant la frappe ----
        input.oninput = e => {
          row.quantite = parseNum(e.target.value);
          saveRowsToStorage();
          // met à jour juste la cellule émissions + agrégats
          const newTotal = parseNum(row.facteur) * parseNum(row.quantite);
          tdEm.textContent = fmt2(newTotal);
          updateAggregates(row.scope);
        };
        // Re-rendu seulement quand on quitte le champ
        input.onblur = () => renderTable();

        tbody.appendChild(tr);
      });

      // Sous-total de la section (cellule avec ID pour MAJ à la volée)
      const subtotal = rowsFiltered.reduce((acc, r) => acc + (parseNum(r.facteur) * parseNum(r.quantite)), 0);
      const trSub = document.createElement('tr');
      trSub.className = 'subtotal-row';
      trSub.innerHTML = `
        <td colspan="4">Sous-total ${scope.replace('_',' ')}</td>
        <td id="subtotal-${scope}">${fmt2(subtotal)} kgCO₂e</td>`;
      tbody.appendChild(trSub);
    });

    // Total général (cellule avec ID pour MAJ à la volée)
    const total = energyRows.reduce((acc, r) => acc + (parseNum(r.facteur) * parseNum(r.quantite)), 0);
    const trTot = document.createElement('tr');
    trTot.className = 'total-row';
    trTot.innerHTML = `<td colspan="4">Total</td><td id="total-energie">${fmt2(total)} kgCO₂e</td>`;
    tbody.appendChild(trTot);

    // Stockage & data globales
    saveRowsToStorage();
    commitEmissionData(total);
  }

  function addEnergyRow(scope) {
    energyRows.push({ scope, categorie: '', engin: '', description: '', quantite: 0, facteur: 0, unite: 'U' });
    afficherDescription('');
    saveRowsToStorage();
    renderTable();
  }

  function saveAndRender() { saveRowsToStorage(); renderTable(); }
  function precedent() { window.location.href = "{{ url_for('transport') }}"; }
  function suivant() {
    const totalEmission = energyRows.reduce((acc, r) => acc + (parseNum(r.facteur) * parseNum(r.quantite)), 0);
    commitEmissionData(totalEmission);
    window.location.href = "{{ url_for('equipements') }}";
  }
  function handleQuit() { sessionStorage.removeItem('energyRows'); window.location.href = "/"; }

  document.addEventListener('DOMContentLoaded', () => {
    const saved = sessionStorage.getItem('energyRows');
    if (saved) {
      energyRows = JSON.parse(saved);
    } else {
      scopes.forEach(scope => addEnergyRow(scope));
    }
    renderTable();
  });
</script>


<!-- Google Translate Widget -->
<div id="google_translate_element" style="position: fixed; top: 10px; right: 10px; z-index: 9999;"></div>

<script type="text/javascript">
  function googleTranslateElementInit() {
    new google.translate.TranslateElement({
      pageLanguage: 'fr',
      includedLanguages: 'en,fr,pt,fon', // Tu peux ajouter d'autres langues ici
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
      autoDisplay: false
    }, 'google_translate_element');
  }
</script>

<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</body>
</html>
